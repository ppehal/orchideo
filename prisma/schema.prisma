// Orchideo FB Triggers - Database Schema
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Auth.js Models (Required for @auth/prisma-adapter)
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  facebookPages    FacebookPage[]
  analyses         Analysis[]
  trendAlerts      TrendAlert[]
  competitorGroups CompetitorGroup[]
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// ============================================================================
// Business Models
// ============================================================================

model FacebookPage {
  id                String   @id @default(cuid())
  fb_page_id        String   @unique
  name              String
  category          String?
  fan_count         Int?
  picture_url       String?
  cover_url         String?
  page_access_token String   // Encrypted with AES-256-GCM
  token_expires_at  DateTime?

  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  analyses   Analysis[]
  snapshots  AnalysisSnapshot[]
  trendAlerts TrendAlert[]

  // Competitor comparison relations
  primaryForGroups CompetitorGroup[] @relation("PrimaryPage")
  competitorIn     CompetitorPage[]  @relation("CompetitorPages")

  @@index([userId])
}

model Analysis {
  id              String         @id @default(cuid())
  status          AnalysisStatus @default(PENDING)
  public_token    String         @unique

  // Page info snapshot
  page_name       String?
  page_picture    String?
  page_fan_count  Int?

  // Industry benchmark
  industry_code   String         @default("DEFAULT")

  // Results
  overall_score   Int?           // 0-100
  rawData         Json?          // Normalized posts + insights

  // Branding options for PDF export
  company_name        String?
  custom_logo_url     String?
  hide_orchideo_branding Boolean @default(false)

  // Email
  email_sent_to   String?
  email_sent_at   DateTime?

  // Timing
  started_at      DateTime?
  completed_at    DateTime?
  expires_at      DateTime?

  // Error handling
  error_message   String?
  error_code      String?

  // Relations
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  fb_page_id      String?
  facebookPage    FacebookPage?  @relation(fields: [fb_page_id], references: [id], onDelete: SetNull)

  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt

  triggerResults  TriggerResult[]
  analyticsEvents AnalyticsEvent[]
  snapshot        AnalysisSnapshot?
  reportArtifacts ReportArtifact[]

  @@index([userId])
  @@index([status])
  @@index([public_token])
  @@index([expires_at])
}

model TriggerResult {
  id           String        @id @default(cuid())
  trigger_code String        // e.g., "BASIC_001", "TECH_003"
  category     TriggerCategory
  score        Int           // 0-100
  status       TriggerStatus

  // Details
  value        Float?        // Measured value
  threshold    Float?        // Expected threshold
  details      Json?         // Additional context (reason, recommendations, etc.)

  analysisId   String
  analysis     Analysis      @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  created_at   DateTime      @default(now())

  @@unique([analysisId, trigger_code])
  @@index([analysisId])
  @@index([trigger_code])
}

model IndustryBenchmark {
  id              String   @id @default(cuid())
  industry_code   String   @unique
  industry_name   String

  // Engagement benchmarks
  avg_engagement_rate     Float   // Average engagement per post per follower
  reactions_pct           Float   // % of interactions that are reactions
  comments_pct            Float   // % of interactions that are comments
  shares_pct              Float   // % of interactions that are shares

  // Content mix
  ideal_engagement_pct    Float   @default(60)  // Engagement content %
  ideal_sales_pct         Float   @default(15)  // Sales content %
  ideal_brand_pct         Float   @default(25)  // Brand content %

  // Posting frequency
  ideal_posts_per_week    Float   @default(3)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  event_type String   // analysis_started, analysis_completed, report_viewed, etc.

  // Context
  analysisId String?
  analysis   Analysis? @relation(fields: [analysisId], references: [id], onDelete: SetNull)

  // Metadata
  metadata   Json?    // Additional event-specific data

  // Tracking
  ip_address String?
  user_agent String?

  created_at DateTime @default(now())

  @@index([event_type])
  @@index([analysisId])
  @@index([created_at])
}

// ============================================================================
// Enums
// ============================================================================

enum AnalysisStatus {
  PENDING
  COLLECTING_DATA
  ANALYZING
  COMPLETED
  FAILED
}

enum TriggerCategory {
  BASIC
  CONTENT
  TECHNICAL
  TIMING
  SHARING
  PAGE_SETTINGS
}

enum TriggerStatus {
  EXCELLENT      // 85-100
  GOOD           // 70-84
  NEEDS_IMPROVEMENT // 40-69
  CRITICAL       // 0-39
}

enum TrendAlertType {
  SCORE_DROP_SIGNIFICANT    // Overall score dropped significantly
  SCORE_IMPROVEMENT         // Overall score improved significantly
  ENGAGEMENT_DROP           // Engagement rate dropped
  ENGAGEMENT_IMPROVEMENT    // Engagement rate improved
  POSTING_FREQUENCY_DROP    // Posting frequency decreased
  POSTING_FREQUENCY_INCREASE // Posting frequency increased
}

// ============================================================================
// Historical Trends Models
// ============================================================================

model AnalysisSnapshot {
  id                String   @id @default(cuid())

  // Metrics (denormalized for trend calculations)
  overall_score     Int
  engagement_rate   Float?
  avg_reactions     Float?
  avg_comments      Float?
  avg_shares        Float?
  posts_per_week    Float?
  fan_count         Int?

  // Versioning for data comparability
  scoring_version   String   @default("1.0")
  benchmark_version String   @default("1.0")

  // Relations
  analysisId        String   @unique
  analysis          Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  fb_page_id        String
  facebookPage      FacebookPage @relation(fields: [fb_page_id], references: [id], onDelete: Cascade)

  created_at        DateTime @default(now())

  @@index([fb_page_id])
  @@index([created_at])
  @@index([fb_page_id, created_at])
}

model TrendAlert {
  id           String         @id @default(cuid())
  type         TrendAlertType
  severity     Int            // 1-3 (1=info, 2=warning, 3=critical)

  // Values
  previous_value Float
  current_value  Float
  change_pct     Float

  // Context
  message      String
  is_read      Boolean        @default(false)

  // Relations
  userId       String
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  fb_page_id   String
  facebookPage FacebookPage   @relation(fields: [fb_page_id], references: [id], onDelete: Cascade)

  created_at   DateTime       @default(now())

  @@index([userId])
  @@index([fb_page_id])
  @@index([userId, is_read])
  @@index([created_at])
}

// ============================================================================
// PDF Export Models
// ============================================================================

model ReportArtifact {
  id            String   @id @default(cuid())

  // Cache key based on params hash
  params_hash   String

  // File location
  file_path     String
  file_size     Int
  mime_type     String   @default("application/pdf")

  // Versioning
  pdf_version   String

  // Relation
  analysisId    String
  analysis      Analysis @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  created_at    DateTime @default(now())

  @@unique([analysisId, params_hash])
  @@index([analysisId])
  @@index([created_at])
}

// ============================================================================
// Competitor Comparison Models
// ============================================================================

model CompetitorGroup {
  id           String   @id @default(cuid())
  name         String
  description  String?

  // Owner
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Primary page being compared (must be owned by user)
  primary_page_id String
  primaryPage     FacebookPage @relation("PrimaryPage", fields: [primary_page_id], references: [id], onDelete: Cascade)

  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Competitor pages in this group
  competitorPages CompetitorPage[]
  comparisons     CompetitorComparison[]

  @@index([userId])
  @@index([primary_page_id])
}

model CompetitorPage {
  id               String          @id @default(cuid())

  // Reference to owned Facebook page used as competitor
  fb_page_id       String
  facebookPage     FacebookPage    @relation("CompetitorPages", fields: [fb_page_id], references: [id], onDelete: Cascade)

  // Group this competitor belongs to
  group_id         String
  group            CompetitorGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)

  created_at       DateTime        @default(now())

  @@unique([group_id, fb_page_id])
  @@index([group_id])
  @@index([fb_page_id])
}

model CompetitorComparison {
  id               String          @id @default(cuid())

  // Snapshot of comparison results
  comparison_data  Json

  // Versioning
  scoring_version  String
  benchmark_version String

  // Group this comparison belongs to
  group_id         String
  group            CompetitorGroup @relation(fields: [group_id], references: [id], onDelete: Cascade)

  created_at       DateTime        @default(now())

  @@index([group_id])
  @@index([created_at])
}
