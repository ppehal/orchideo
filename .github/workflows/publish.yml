# =============================================================================
# Publish - Docker Build & Push to GHCR
# =============================================================================
# Builds and pushes Docker images to GitHub Container Registry
# - stage branch -> web-stage-* tags
# - main branch -> web-prod-* tags
# =============================================================================

name: Publish Docker Image

# TEMPORARILY DISABLED during initial development
# To re-enable: remove the 'if: false' condition from the job below

on:
  push:
    branches: [main, stage]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/orchideo

jobs:
  build-and-push:
    # DISABLED: Remove this line to re-enable workflow
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 20

    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: meta
        run: |
          SHA=${GITHUB_SHA::7}
          DATE=$(date -u +%Y%m%d-%H%M)

          if [[ "${{ github.ref_name }}" == "main" ]]; then
            PREFIX="web-prod"
          else
            PREFIX="web-stage"
          fi

          echo "TAG_PREFIX=${PREFIX}" >> $GITHUB_OUTPUT
          echo "TAG_DATE=${DATE}" >> $GITHUB_OUTPUT
          echo "TAG_SHA=${SHA}" >> $GITHUB_OUTPUT
          echo "APP_VERSION=${PREFIX}-${DATE}-${SHA}" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.TAG_PREFIX }}-${{ steps.meta.outputs.TAG_DATE }}
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.TAG_PREFIX }}-${{ steps.meta.outputs.TAG_SHA }}
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.TAG_PREFIX }}-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            DATABASE_URL=postgresql://dummy:dummy@localhost:5432/dummy
            APP_VERSION=${{ steps.meta.outputs.APP_VERSION }}
          provenance: false
          sbom: false

      - name: Print published tags
        run: |
          echo "Published to GHCR:"
          echo "  ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.TAG_PREFIX }}-${{ steps.meta.outputs.TAG_DATE }}"
          echo "  ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.TAG_PREFIX }}-${{ steps.meta.outputs.TAG_SHA }}"
          echo "  ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.TAG_PREFIX }}-latest"
